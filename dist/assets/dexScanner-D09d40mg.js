function j(f){if(!f)return{strings:[],classes:[],methods:[],fields:[],error:"Empty buffer"};try{let w=function(n){let i=0,c=0,r=0;for(;n+r<e.byteLength;){const a=e.getUint8(n+r);if(r++,i|=(a&127)<<c,!(a&128))break;c+=7}return{value:i,bytesRead:r}};const e=new DataView(f),d=e.getUint32(0,!0);if(d!==175662436)return console.warn("Invalid DEX magic number: "+d.toString(16)),{strings:[],classes:[],methods:[],fields:[],error:"Invalid DEX magic"};const t=e.getUint32(40,!0)===305419896,b=e.getUint32(56,t),I=e.getUint32(60,t),u=e.getUint32(64,t),g=e.getUint32(68,t),h=e.getUint32(80,t),p=e.getUint32(84,t),y=e.getUint32(88,t),m=e.getUint32(92,t),k=e.getUint32(96,t),x=e.getUint32(100,t),s=[],l=[],U=[],v=[],D=[],C=new TextDecoder("utf-8");for(let n=0;n<b&&!(I+n*4+4>e.byteLength);n++){const i=e.getUint32(I+n*4,t);if(i>=e.byteLength){s.push("");continue}const{bytesRead:c}=w(i);let r=i+c,a=r;for(;a<e.byteLength&&e.getUint8(a)!==0;)a++;const L=new Uint8Array(f,r,a-r),M=C.decode(L);s.push(M)}for(let n=0;n<u&&!(g+n*4+4>e.byteLength);n++){const i=e.getUint32(g+n*4,t);l.push(s[i]||"")}for(let n=0;n<h;n++){const i=p+n*8;if(i+8>e.byteLength)break;const c=e.getUint16(i,t),r=e.getUint32(i+4,t),a=l[c]||"",L=s[r]||"";U.push(`${a}->${L}`)}for(let n=0;n<y;n++){const i=m+n*8;if(i+8>e.byteLength)break;const c=e.getUint16(i,t),r=e.getUint32(i+4,t),a=l[c]||"",L=s[r]||"";v.push(`${a}->${L}`)}for(let n=0;n<k;n++){const i=x+n*32;if(i+32>e.byteLength)break;const c=e.getUint32(i,t);D.push(l[c]||"")}return{strings:s,types:l,fields:U,methods:v,classNames:D}}catch(e){return console.error("DEX Parsing failed:",e),{strings:[],types:[],fields:[],methods:[],classNames:[],error:e.message}}}function E(f){const{strings:e,methods:d}=f,o={suspiciousStrings:[],riskyMethods:[],riskIndicators:[],scoreContribution:0},t=(s,l,U,v)=>{o.riskIndicators.push({type:s,reason:l,evidence:U}),o.scoreContribution+=v},b=s=>e.some(l=>l.includes(s)),I=e.filter(s=>s.length>3),u=d.filter(s=>s.includes("dalvik/system/DexClassLoader")||s.includes("dalvik/system/PathClassLoader")||s.includes("loadDex")).slice(0,3);u.length>0?(t("high","Dynamic Code Loading detected",u.join(", "),25),o.riskyMethods.push(...u)):(b("DexClassLoader")||b("PathClassLoader"))&&(t("medium","References to ClassLoaders found in strings","DexClassLoader/PathClassLoader found",10),o.suspiciousStrings.push("DexClassLoader"));const g=d.filter(s=>s.includes("Ljava/lang/reflect/Method;->invoke")||s.includes("Ljava/lang/Class;->forName")).slice(0,3);g.length>0&&(t("medium","Usage of Java Reflection API",g.join(", "),15),o.riskyMethods.push(...g));const h=d.filter(s=>s.includes("Landroid/telephony/TelephonyManager;->getDeviceId")||s.includes("Landroid/telephony/TelephonyManager;->getImei")||s.includes("Landroid/telephony/SmsManager;->sendTextMessage")||s.includes("Landroid/media/AudioRecord;->startRecording")||s.includes("Landroid/hardware/Camera;->open")||s.includes("Landroid/hardware/camera2/CameraManager;->openCamera")).slice(0,5);h.length>0&&(t("high","Direct usage of sensitive hardware or identity APIs",h.join(", "),20),o.riskyMethods.push(...h));const p=d.filter(s=>s.includes("Ljavax/crypto/Cipher;->getInstance")).slice(0,3);p.length>0&&(t("medium","Usage of cryptographic routines",p.join(", "),5),o.riskyMethods.push(...p));const y=d.filter(s=>s.includes("Landroid/webkit/WebView;->addJavascriptInterface")).slice(0,3);y.length>0&&(t("high","Insertion of JS interfaces into WebView (potential arbitrary code execution if unsanitized)",y.join(", "),20),o.riskyMethods.push(...y));const m=d.filter(s=>s.includes("Ljava/lang/Runtime;->exec")||s.includes("Ljava/lang/ProcessBuilder;->start")).slice(0,3);m.length>0&&(t("high","Execution of shell commands via Runtime/ProcessBuilder",m.join(", "),25),o.riskyMethods.push(...m));const k=/^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$/,x=I.filter(s=>k.test(s)).slice(0,3);return x.length>0&&(t("medium","Hardcoded IP addresses found in strings",x.join(", "),10),o.suspiciousStrings.push(...x)),o}function S(f){if(!f)return null;const e=j(f);return e.error?null:E(e)}export{j as parseDex,S as scanDexWorkerFriendly,E as scanForRiskPatterns};
